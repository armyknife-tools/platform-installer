#!/usr/bin/env bash
# ArmyknifeLabs API Key Manager
# Supports both LastPass and 1Password

# Source the bashlib
source /home/developer/.armyknife/bashlib/lib/main.sh

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
PURPLE='\033[0;35m'
NC='\033[0m'

show_help() {
    echo -e "${BLUE}ArmyknifeLabs API Key Manager${NC}"
    echo ""
    echo "Usage: ak-apikey <provider> <command> [options]"
    echo ""
    echo -e "${PURPLE}Providers:${NC}"
    echo "  lp, lastpass   - Use LastPass for storage"
    echo "  1p, 1password  - Use 1Password for storage (with env var references)"
    echo "  age            - Use age encryption for local storage"
    echo "  secure         - Hybrid: password manager + age backup"
    echo ""
    echo -e "${PURPLE}LastPass Commands:${NC}"
    echo "  lp add <name> <key> [folder]   - Store an API key in LastPass"
    echo "  lp get <name> [folder]          - Retrieve an API key from LastPass"
    echo "  lp list [folder]                - List all stored API keys"
    echo ""
    echo -e "${PURPLE}1Password Commands:${NC}"
    echo "  1p add <name> <key> [vault]    - Store API key with env var reference"
    echo "  1p get <name> [vault]           - Retrieve an API key from 1Password"
    echo "  1p list [vault]                 - List all stored API keys"
    echo "  1p env [file] [vault]           - Create .env file with 1Password refs"
    echo ""
    echo -e "${PURPLE}Age Encryption Commands:${NC}"
    echo "  age add <name> <key>            - Encrypt and store locally"
    echo "  age get <name>                  - Decrypt and retrieve key"
    echo "  age list                        - List all encrypted keys"
    echo "  age backup [file]               - Create encrypted backup of all keys"
    echo ""
    echo -e "${PURPLE}Hybrid Security:${NC}"
    echo "  secure add <name> <key> [provider] - Store in both password manager + age"
    echo ""
    echo -e "${GREEN}Examples:${NC}"
    echo "  ak-apikey lp add 'OpenAI' 'sk-xxxxx'"
    echo "  ak-apikey 1p add 'OPENAI_API_KEY' 'sk-xxxxx' 'Development'"
    echo "  ak-apikey age add 'GITHUB_TOKEN' 'ghp_xxxxx'"
    echo "  ak-apikey secure add 'OPENAI_API_KEY' 'sk-xxxxx' 1p"
    echo "  ak-apikey age backup ~/keys-backup.tar.age"
    echo ""
    echo -e "${YELLOW}Security Layers:${NC}"
    echo "  • 1Password: \$2.99/mo, cloud sync, env var references"
    echo "  • LastPass: Cloud storage, team sharing"
    echo "  • Age: Local encryption, air-gapped security, Git-safe"
    echo "  • Hybrid: Maximum security with multiple backups"
    echo ""
    echo -e "${YELLOW}Age Encryption Benefits:${NC}"
    echo "  • Works offline and in CI/CD pipelines"
    echo "  • Can be stored in Git repositories (encrypted)"
    echo "  • No external dependencies for decryption"
    echo "  • Perfect for air-gapped environments"
}

# Main command handling
case "$1" in
    lp|lastpass)
        shift
        case "$1" in
            add)
                shift
                add-api-key "$@"
                ;;
            get)
                shift
                get-api-key "$@"
                ;;
            list)
                shift
                list-api-keys "$@"
                ;;
            *)
                echo -e "${RED}Unknown LastPass command: $1${NC}"
                show_help
                exit 1
                ;;
        esac
        ;;
    1p|1password|op)
        shift
        case "$1" in
            add)
                shift
                add-1p-api-key "$@"
                ;;
            get)
                shift
                get-1p-api-key "$@"
                ;;
            list)
                shift
                list-1p-api-keys "$@"
                ;;
            env)
                shift
                setup-1p-env "$@"
                ;;
            *)
                echo -e "${RED}Unknown 1Password command: $1${NC}"
                show_help
                exit 1
                ;;
        esac
        ;;
    age)
        shift
        case "$1" in
            add)
                shift
                age-encrypt-key "$@"
                ;;
            get)
                shift
                age-decrypt-key "$@"
                ;;
            list)
                shift
                list-age-keys "$@"
                ;;
            backup)
                shift
                backup-api-keys "$@"
                ;;
            *)
                echo -e "${RED}Unknown age command: $1${NC}"
                show_help
                exit 1
                ;;
        esac
        ;;
    secure)
        shift
        case "$1" in
            add)
                shift
                secure-api-key "$@"
                ;;
            *)
                echo -e "${RED}Unknown secure command: $1${NC}"
                show_help
                exit 1
                ;;
        esac
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        if [ -z "$1" ]; then
            show_help
        else
            echo -e "${RED}Unknown provider: $1${NC}"
            echo "Use 'lp' for LastPass, '1p' for 1Password, 'age' for encryption, or 'secure' for hybrid"
            echo ""
            show_help
            exit 1
        fi
        ;;
esac